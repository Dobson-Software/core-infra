name: Build & Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-backend:
    name: Build Backend JARs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build all services
        run: ./gradlew bootJar --no-daemon -x test -x checkstyleMain -x checkstyleTest -x checkNoMocks

      - name: Upload JARs
        uses: actions/upload-artifact@v6
        with:
          name: backend-jars
          path: |
            backend/core-service/build/libs/*.jar
            backend/notification-service/build/libs/*.jar
            backend/violations-service/build/libs/*.jar

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Upload build
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: frontend/apps/web/dist/

  docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main'
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v6

      - name: Set image tag
        id: tag
        run: echo "tag=sha-${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build core-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.core
          push: false
          load: true
          tags: |
            cobalt/core-service:${{ github.sha }}
            ${{ steps.ecr-login.outputs.registry }}/cobalt/core-service:${{ steps.tag.outputs.tag }}

      - name: Scan core-service image
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: cobalt/core-service:${{ github.sha }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: Build notification-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.notification
          push: false
          load: true
          tags: |
            cobalt/notification-service:${{ github.sha }}
            ${{ steps.ecr-login.outputs.registry }}/cobalt/notification-service:${{ steps.tag.outputs.tag }}

      - name: Scan notification-service image
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: cobalt/notification-service:${{ github.sha }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: Build violations-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.violations
          push: false
          load: true
          tags: |
            cobalt/violations-service:${{ github.sha }}
            ${{ steps.ecr-login.outputs.registry }}/cobalt/violations-service:${{ steps.tag.outputs.tag }}

      - name: Scan violations-service image
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: cobalt/violations-service:${{ github.sha }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: Push images to ECR
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          for svc in core-service notification-service violations-service; do
            echo "Pushing ${ECR_REGISTRY}/cobalt/${svc}:${IMAGE_TAG}"
            docker push "${ECR_REGISTRY}/cobalt/${svc}:${IMAGE_TAG}"
          done
          echo "All images pushed to ECR with tag ${IMAGE_TAG}"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]

    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner (backend)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: ./backend
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        run: cd frontend && pnpm install --frozen-lockfile

      - name: Run npm audit
        run: cd frontend && pnpm audit --audit-level=high

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@1.1.0
        with:
          project: cobalt
          path: ./backend
          format: HTML
          args: >
            --failOnCVSS 7
            --suppression backend/config/owasp-suppressions.xml

      - name: Checkov IaC scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/terraform
          framework: terraform
          config_file: infrastructure/terraform/.checkov.yml
