apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: cobalt-services
  labels:
    app: notification-service
    app.kubernetes.io/name: notification-service
    app.kubernetes.io/part-of: cobalt
spec:
  replicas: 2
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
        app.kubernetes.io/name: notification-service
    spec:
      serviceAccountName: notification-service
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: notification-service
      terminationGracePeriodSeconds: 45
      initContainers:
        - name: wait-for-db
          image: busybox:1.36.1@sha256:65ad0d468eb1c558bf7f4e64e790f586e9eda4c92c23bc8a5698b23a16e5f6d8
          command: ['sh', '-c', 'max_retries=30; i=0; until nc -z ${DB_HOST:-postgres} 5432 || [ $i -ge $max_retries ]; do echo "waiting for db ($i/$max_retries)"; sleep 2; i=$((i+1)); done; if [ $i -ge $max_retries ]; then echo "ERROR: Database not reachable after $max_retries attempts"; exit 1; fi']
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: db-host
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      containers:
        - name: notification-service
          image: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/cobalt/notification-service:${IMAGE_TAG}"
          ports:
            - name: http
              containerPort: 8081
              protocol: TCP
            - name: management
              containerPort: 8090
              protocol: TCP
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 256m
              memory: 768Mi
            limits:
              cpu: "1"
              memory: 1536Mi
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: SPRING_DATASOURCE_URL
              valueFrom:
                secretKeyRef:
                  name: cobalt-db-credentials
                  key: url
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: cobalt-db-credentials
                  key: username
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cobalt-db-credentials
                  key: password
            - name: SPRING_REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: redis-host
            - name: SPRING_REDIS_PORT
              value: "6379"
            - name: SPRING_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cobalt-redis-auth
                  key: password
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: cobalt-jwt-secret
                  key: secret
            - name: CORS_ALLOWED_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: cors-allowed-origins
            - name: TWILIO_ACCOUNT_SID
              valueFrom:
                secretKeyRef:
                  name: cobalt-twilio-credentials
                  key: account-sid
            - name: TWILIO_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: cobalt-twilio-credentials
                  key: auth-token
            - name: TWILIO_PHONE_NUMBER
              valueFrom:
                secretKeyRef:
                  name: cobalt-twilio-credentials
                  key: phone-number
            - name: SPRING_MAIL_HOST
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: MAIL_HOST
            - name: SPRING_MAIL_PORT
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: MAIL_PORT
            - name: SPRING_MAIL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: cobalt-mail-credentials
                  key: username
            - name: SPRING_MAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cobalt-mail-credentials
                  key: password
            - name: COBALT_EMAIL_FROM_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: email-from-address
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: cobalt-config
                  key: otel-endpoint
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 5"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /api/actuator/health/liveness
              port: 8090
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/actuator/health/readiness
              port: 8090
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /api/actuator/health
              port: 8090
            failureThreshold: 30
            periodSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: cobalt-services
  labels:
    app: notification-service
spec:
  type: ClusterIP
  selector:
    app: notification-service
  ports:
    - name: http
      port: 8081
      targetPort: 8081
      protocol: TCP
    - name: management
      port: 8090
      targetPort: 8090
      protocol: TCP
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: notification-service
  namespace: cobalt-services
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: notification-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
