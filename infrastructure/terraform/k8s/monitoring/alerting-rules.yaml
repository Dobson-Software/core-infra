apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cobalt-alerts
  namespace: cobalt-monitoring
  labels:
    app.kubernetes.io/part-of: cobalt
spec:
  groups:
    - name: cobalt.pod-health
      rules:
        - alert: PodCrashLooping
          expr: increase(kube_pod_container_status_restarts_total{namespace="cobalt-services"}[15m]) > 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} is crash looping"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in the last 15 minutes."

        - alert: PodNotReady
          expr: kube_pod_status_ready{namespace="cobalt-services", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} is not ready"
            description: "Pod {{ $labels.pod }} has been in a non-ready state for more than 5 minutes."

    - name: cobalt.http
      rules:
        - alert: HighErrorRate
          expr: sum(rate(http_server_requests_seconds_count{namespace="cobalt-services", status=~"5.."}[5m])) by (application) / sum(rate(http_server_requests_seconds_count{namespace="cobalt-services"}[5m])) by (application) > 0.01
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High 5xx error rate on {{ $labels.application }}"
            description: "{{ $labels.application }} has a 5xx error rate of {{ $value | humanizePercentage }} over the last 5 minutes."

        - alert: HighP99Latency
          expr: histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{namespace="cobalt-services"}[5m])) by (le, application)) > 2
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High P99 latency on {{ $labels.application }}"
            description: "{{ $labels.application }} P99 latency is {{ $value }}s (threshold: 2s)."

    - name: cobalt.database
      rules:
        - alert: HikariPoolExhausted
          expr: hikaricp_connections_active{namespace="cobalt-services"} / hikaricp_connections_max{namespace="cobalt-services"} > 0.9
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "HikariCP pool near exhaustion on {{ $labels.application }}"
            description: "{{ $labels.application }} is using {{ $value | humanizePercentage }} of its connection pool."

        - alert: HikariConnectionTimeout
          expr: increase(hikaricp_connections_timeout_total{namespace="cobalt-services"}[5m]) > 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "HikariCP connection timeouts on {{ $labels.application }}"
            description: "{{ $labels.application }} has {{ $value }} connection timeouts in the last 5 minutes."

    - name: cobalt.scaling
      rules:
        - alert: HPAAtMaxReplicas
          expr: kube_horizontalpodautoscaler_status_current_replicas{namespace="cobalt-services"} == kube_horizontalpodautoscaler_spec_max_replicas{namespace="cobalt-services"}
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "HPA {{ $labels.horizontalpodautoscaler }} at max replicas"
            description: "{{ $labels.horizontalpodautoscaler }} has been at maximum replicas for 15 minutes â€” consider increasing max."
