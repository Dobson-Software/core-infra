# WARNING: This file contains ${VAR} references (e.g. ${CLUSTER_NAME},
# ${ENVIRONMENT}, ${AXIOM_DATASET}, ${AXIOM_API_TOKEN}) that are resolved at
# runtime by Fluent Bit from container environment variables. Do NOT pipe this
# file through envsubst or similar shell-variable substitution tools, as that
# would replace these references with empty strings and break the config.
# If your deploy pipeline uses envsubst on K8s manifests, exclude this file or
# use the $$ escape syntax in your envsubst invocation.
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    # Baseline allows hostPath volumes required by Fluent Bit for log collection.
    # Fluent Bit needs /var/log access to ship container logs to Axiom.
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: baseline
    pod-security.kubernetes.io/warn: baseline
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-env
  namespace: monitoring
  labels:
    app: fluent-bit
data:
  # These values are used by the Fluent Bit DaemonSet to tag log entries.
  # They live in the monitoring namespace (not cobalt-services) so the
  # DaemonSet can reference them without cross-namespace issues.
  # Update these when deploying to match the target cluster/environment.
  cluster-name: "${CLUSTER_NAME}"
  environment: "${ENVIRONMENT}"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: monitoring
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*_cobalt-services_*.log
        Parser            cri
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  10

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
        Labels              On
        Annotations         Off

    [FILTER]
        Name   modify
        Match  kube.*
        Add    cluster ${CLUSTER_NAME}
        Add    environment ${ENVIRONMENT}

    [OUTPUT]
        Name            http
        Match           kube.*
        Host            api.axiom.co
        Port            443
        URI             /v1/datasets/${AXIOM_DATASET}/ingest
        Header          Authorization Bearer ${AXIOM_API_TOKEN}
        Header          Content-Type application/json
        Format          json_lines
        Json_date_key   _time
        Json_date_format iso8601
        TLS             On
        Retry_Limit     3

  parsers.conf: |
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        json
        Format      json
        Time_Key    @timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: monitoring
  labels:
    app: fluent-bit
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    metadata:
      labels:
        app: fluent-bit
    spec:
      serviceAccountName: fluent-bit
      terminationGracePeriodSeconds: 10
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:3.2@sha256:41370c4edd3a09db6565271ef647a5f69808007cf6c8ce5f205e056a77a18f41
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          env:
            - name: AXIOM_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiom-credentials
                  key: api-token
            - name: AXIOM_DATASET
              valueFrom:
                secretKeyRef:
                  name: axiom-credentials
                  key: dataset
            # CLUSTER_NAME and ENVIRONMENT are resolved at runtime by Fluent Bit.
            # These use a local ConfigMap in the monitoring namespace (not cobalt-config
            # which lives in cobalt-services — cross-namespace ConfigMap refs don't work).
            - name: CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: fluent-bit-env
                  key: cluster-name
                  optional: true
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: fluent-bit-env
                  key: environment
                  optional: true
          volumeMounts:
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: config
              mountPath: /fluent-bit/etc/
              readOnly: true
            - name: flb-db
              mountPath: /var/log/flb_kube.db
              subPath: flb_kube.db
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: config
          configMap:
            name: fluent-bit-config
        - name: flb-db
          emptyDir: {}
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
---
################################################################################
# Network Policies — monitoring namespace
################################################################################

# Default deny all ingress and egress in monitoring namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow Fluent Bit egress to Axiom (HTTPS) and Kubernetes API (metadata enrichment)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: fluent-bit
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: fluent-bit
  policyTypes:
    - Egress
  egress:
    # DNS
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # HTTPS — Axiom (api.axiom.co) and Kubernetes API metadata enrichment
    - ports:
        - protocol: TCP
          port: 443
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluent-bit
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluent-bit
rules:
  - apiGroups: [""]
    resources: ["namespaces", "pods"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fluent-bit
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fluent-bit
subjects:
  - kind: ServiceAccount
    name: fluent-bit
    namespace: monitoring
